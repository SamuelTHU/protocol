4# Gossip

As explained in the [Sync](SYNC.md) document, any blockchain implementation
needs communication with peers in order to be truly useful. Apart from the lower
level details described in that document, there is the added dimension of
how peers are selected for communication, how connections to those peers are
maintained over time. This is the purpose of gossiping functionality.

## Initial Configuration

The initial set of peers is defined by configuration when starting the node.
This is a predefined set of peers that are automatically connected to upon
startup.

## Peers

A peer is identified by a URI consisting of the protocol 'aenode://', the public
key, an '@' character, the hostname or IP number, a ':' character and the Noise
port number the node is using. If the address contains a hostname, it will be
resolved to an IP. Example:

'''
aenode://pp$HryRGHJ7Ct3trkktVyVBgfhHL1J4EYSD9cScuMZDV61eSHrCZ@mynode.example.com:3015
'''

A node is uniquely identified by its public key, and it can only have one IP and
port at the same time. This means one IP can have several instanced of Epoch
started at the same time listening on different ports if they have different
public keys. This key corresponds to the private key that is used for the Noise
protocol listener associated with the IP and port.

Apart from being used in encryption via the Noise protocol, the public key is
also used to determine which node should keep its initiated connection open in
case two connections are opened (see [Gossiping of New Peers](#gossiping-of-new-
peers)).

### Gossiping of New Peers

Whenever a ping message is exchanged between peers, either a ping request or
ping response, the peers also attach a subset of neighboring peers they know of.
The node that generates the message populates the neighbor list with 30 peers
that are randomly selected from its pool of verified peers (see
[Peers Maintenance](#peers-maintenance)).

When a ping request is received from another peer, that peer is first checked
for acceptance. This includes verifying

1. It is not the local node itself
2. The peer is not on the blocked list
3. It doesn't already have an existing connection

(3) refers to the case where two peers have learned about each other separately
and are both trying to initiate a connection. The connections are both initiated
via Noise, but once they are connected each node checks if they already have a
connection to that same peer. If they do, they will keep it if their public key
is larger than their peers, and drop it if not. This ordering of keys is
arbitrary but achieves the effect of only ever being true at one node or the
other. Thus, only one connection is kept.

Once the peer is accepted, all the neighbors not already verified are added to
the unverified pool. If this is the first ping from an incoming connection from
an unverified peer, the peer itself is added to the unverified pool too
(see [Peers Maintenance](#peers-maintenance) for more details).

### Peers Maintenance

The objectives of peer maintenance are:

1. Prevent peer poisoning (Sybil/eclipse attack)
2. Limit the number of active peer connections
3. Cache the known peers between restart to make peer poisoning harder.

To prevent an attacker from poisoning the list of peers, isolating the
node from the rest of the network, we make it impossible to predict
the set of peer's IP/port the attacker should control to fill enough of the list
for the attack to be statistically successful. In addition, we randomize the
peer eviction to prevent an attacker from predicting it and replace all good
peers for there own compromised ones.

This is achieved by first categorizing peers in two groups:

1. The unverified pool contains all the peers received through gossip.
It ensures no Byzantine node can fill it completely by limiting the subset
of the pool it can affect; it prevents attackers from predicting the set of
IP/port they must use to successfully eclipse the node.

2. The verified pool contains the peers the node connected to explicitly after
passing through the filter of the unverified pool. It randomizes the peer
distribution to the eye of attackers, preventing them from predicting the
eviction algorithm.

Peers are considered verified when the node has been able to connect to
them using the Noise protocol. Incoming connections from unverified peers are
kept in a very small separated pool to give new nodes the opportunity to join
the cluster without allowing eclipse attacks.

Both groups clusterize peers into multiple buckets; they select which one
an added peer belongs to based on a combination of the address of the node the
information is coming from, the address of the peer to be added and a secret
generated by the node for the purpose of randomizing the selection process.
See [Unverified Pool](#unverified-pool) and [Verified Pool](#verified-pool) for
more details on how the peers are added to the pools.

The peers received from configuration are added directly to the verified pool
and are marked as "trusted", meaning that they will never get downgraded to the
unverified pool even if the node cannot connect to them.

### Connections

There is two pool of connections, the main one contains the connections to
verified peers, the other one is a small pool only for incoming connection from
unverified peers.

Incoming connections from verified peers are kept if the maximum number of
verified connections as not been reached yet, otherwise, the connection is
closed after receiving the ping and the response has been sent. Note that if an
outgoing connection to the same peer already exists, only the one from the node
with the largest public key will be kept to resolve simultaneous connection
conflicts.

Incoming connections from unverified peers are kept in a small pool to allow
new node the opportunity to join the cluster while protecting against eclipse
attacks. When the small pool is full, adding a new one causes the oldest one to
be closed.

When started, the node will iteratively pick a random peer from the verified
pool (not yet connected). If there are no more peers available in the verified
pool, a random one is picked from the unverified pool. If there already is an
unverified incoming connection to the picked peer, the connection is removed
from the incoming connection pool and the peer is upgraded to the verified
pool, otherwise, the node tries to connect to it. If the connection succeeds, an
unverified peer is upgraded to the verified pool and removed from the unverified
pool. If the connection fails, the peer retry counter and last retry time are
updated.

When successfully connecting to a peer, all the peers with the same public key
but different IP/port are removed from both pools; this prevents peers with
variable addresses to accumulate in the pools.

The node will first burst-connect to 10 peers and then periodically connects to
more until it reaches the maximum number of verified connections. Then it will
periodically disconnect a verified peer and pick a new one. This slow rotation
allows the verified peers to be periodically checked and cleaned up, and at the
same time gives new nodes an opportunity to integrate the cluster.

The peer retry counter and last retry time (initialized to `0` and `infinity`),
are used to filter out peers when picking them from the pools providing
exponential backoff. After N failed attempts, a verified peer that is not
marked as trusted is downgraded to the unverified pool and the counter and time
is reset; unverified peers are simply removed.

Connected peers will periodically be pinged, and their connection state
monitored. The ping interval is configurable and defaults to once every 120
seconds. If a ping fails, this is logged and the peer is scheduled for another
ping in the normal interval.

#### Connection Cleanup

Connections are monitored and cleaned when inactive to prevent an attacker
from isolating the node by blocking chain traffic. If there is actually no
traffic it will just accelerate the connection rotation.

- All connections without any chain-related activity (not counting gossip) for
more than 180 seconds will get disconnected.
- All incoming connections that don't send a ping after 30 seconds will be
disconnected.
- All recent incoming connections from unverified peers (less than 90 seconds
old) without any chain-related activity (not counting gossip) will be closed;
this is to favor active connections in the small unverified connection pool.
- When the maximum number of verified connections has been reached, a random
peer is disconnected every 30 seconds.

#### Unverified Peers

The unverified pool is composed of 1024 buckets of up to 64 peers, resulting in
a maximum capacity of 65536 peers.

To prevent a rogue node to fill it with compromised peers, it uses the address
of the node gossiping the peers to select a subset of the bucket; then the added
peer address is used to select the bucket it belongs to. A secret known only by
the node is used to randomize the selection process so it cannot be predicted
by the attacker.

If a peer is not already in the verified pool, the steps to add it to the
unverified pool are:

1. If there is already 8 references of the peer in the pool, no more
references are added; if there is N references, a random probability check of
`1/2^N` is performed to decide if another reference to the peer should be added.
2. A subset of 64 buckets are selected based on the secret and the IP of the
node that gossiped the peer; this limits the part of the pool that can be
changed by any given rogue node IP.
3. From this subset, 16 buckets are selected based on the secret and the IP of
the peer to be added; this randomizes the peer distribution preventing the
prediction of the way peers will be evicted.
4. From these 16 buckets, a single one is selected based on the secret and the
port of the added peer; this reduces the collisions between peers that share the
same IP.
5. If the bucket the peer has to be added to is full, one existing peer has to
be evicted. This is done by first cleaning all the peers that weren't gossiped
for a certain amount of time, then if the bucket is still full, by selecting a
random peer with a bias favoring peers that were added the longest time ago.
6. The eventually evicted peer is completely removed from the pool.

Only the IP of the source node is used to select a subset of the pool because
IP is an expensive resource while ports are comparatively cheap.

See [Bucket Selection](#bucket-selection) for more details on how the buckets
are selected from the secret and other discriminators.

#### Verified Peers

The verified pool is composed of 256 buckets of up to 32 peers, resulting in a
maximum capacity of 8192 peers.

To prevent attackers from predicting how good peers are evicted and replace them
by compromised peers, the eviction is done per-bucket; the buckets are selected
from the peer address and a secret to randomize the selection process.

When a peer is verified the first time by connecting to it using the Noise
protocol (only outgoing connections), it is removed from the unverified pool
and the steps to add it to the verified pool are:

1. A subset of 16 buckets are selected based on the secret and the IP of the
peer to be added.
2. From this subset, a single bucket is selected based on the secret and the
port of the peer to be added; the IP and port are different discriminators to
prevent peers sharing the same port to affect the whole pool.
3. If the bucket is full, one peer has to be evicted. This is done by first
cleaning the peers that weren't gossiped for a long time, and if the bucket is
still full, by selecting a random one with a bias toward the ones that are not
connected and the last connection was the longest time ago. Trusted peers are
never evicted.
4. The eventually evicted peer is added to the unverified pool; its retry
counter and last retry time are reset. If the node is connected to the evicted
peer, the connection is closed.

See [Bucket Selection](#bucket-selection) for more details on how the buckets
are selected from the secret and other discriminators.

#### Technical Details

##### Constants

List of constants with there current default values:

 - Maximum number of verified connections: 4096
 - Maximum number of unverified connections (incoming): 16
 - Number of buckets in the verified pool: 2^8 (256)
 - Number of peer per verified buckets: 2^5 (32)
 - Number of buckets in the unverified pool: 2^10 (1024)
 - Number of peer per unverified buckets: 2^6 (64)
 - Maximum number of duplicated peers in the unverified pool: 8
 - Probability of adding an Nth duplicated reference of an existing peer to the unverified pool: `1/2^N`
 - Period of verified peer random disconnection when the maximum number
 of verified connections has been reached: 60 seconds
 - Number of peers connected as a burst during startup: 10
 - Period of new peer connection up to the maximum number of verified
 connections: 10 seconds.
 - Gossip ping frequency: 120 seconds
 - Maximum time to get a ping from an incoming connection: 30 seconds
 - Maximum time without activity (besides gossip) for incoming unverified
 connections less than 90 seconds old: 30 seconds
 - Maximum time without activity (besides gossip) for all connections: 180 seconds
 - Number of unverified buckets selected based on the source IP: 64
 - Number of unverified sub-buckets selected based on the peer IP: 16
 - Number of verified buckets selected based on peer IP: 16

With these default values:

- The maximum cumulated number of distinct peers in the pools is from
16384 to 73728 depending on peer duplication in the unverified pool.
- The maximum number of peers that can be added through gossip by peers sharing
the same IP is from 512 to 4016 depending on peer duplication in the unverified
pool.
- The maximum number of neighboring peers sharing the same IP a single node
can add through gossip is from 128 to 1024 depending on peer duplication in the
unverified pool.
- Given the random disconnections every minute when the maximum number of
verified connection has been reached, the longest time a connection to the
same node will be kept is 2.8 days (68 hours).
- Given the delay between connection to verified peers, a node will need a
minimum of around 11 hours to reach its maximum number of verified connection.

##### Bucket Selection

The bucket selection is done by hashing the secret with the discriminator and
use the result as an integer; this integer modulo is used to restrict the
subset.

For the unverified bucket selection (without optional duplication):

```Erlang
  <<N1:160>> = crypto:hash(sha, <<Secret/binary, SourceIP/binary>>),
  <<N2:160>> = crypto:hash(sha, <<Secret/binary, PeerIP/binary, (N1 rem 64)>>),
  <<N3:160>> = crypto:hash(sha, <<Secret/binary, PeerPort/binary, (N2 rem 16)>>),
  BucketIdx = N3 rem 1024.
```

For the verified bucket selection:

```Erlang
  <<N1:160>> = crypto:hash(sha, <<Secret/binary, PeerIP/binary>>).
  <<N2:160>> = crypto:hash(sha, <<Secret/binary, PeerPort/binary, (N1 rem 16)>>).
  BucketIdx = N2 rem 256.
```

#### Concerns

- Ensure that with a bounded number of connections the cluster can be larger
than the maximum number of connection per node:

  The verified pool distribute and evict peers based on a secret different
  on each node; that should randomize the set of peers the node will connect to
  allowing nodes to form a mesh network.

- Ensure a new node can join a network where all existing nodes may have reach
there maximum number of connections.

  To allow new nodes to join a cluster even when all existing nodes have
  reached the maximum number of outgoing connections, while still be safe
  against eclipse attack, every node accepts a small number of incoming
  connection from unverified peers. When a peer is added to this very small FIFO
  pool (16) of the incoming connection and the maximum size is reached, the oldest
  one to get closed. The peers are not verified, but the pool is small enough so
  the peers cannot be used to eclipse the node. This in addition to the
  periodic random disconnection of verified peers should allow new nodes t

#### Persistence

Persistence of the known peers is important in preventing Sybil/eclipse attacks.

If the node rebuild its list of peers from scratch every time it is restarted,
an attacker could use any other attack vector to crash the node or wait for
a scheduled restart and be the first to spam it with compromised addresses.

To support persistence, the verified pool or both pools could be dumped to disk
at regular intervals alongside the secret used for the bucket selection.
